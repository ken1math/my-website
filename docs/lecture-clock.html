<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ë¨õÁæ©Áî®ÊôÇË®à</title>
  <style>
    :root{
      --bg:#071026;
      --fg:#e6f0ff;
      --warn:#ff6b6b;
      --accent:#4da6ff;
      --scale: 1;
      --switch-on: #4CAF50;
      --switch-off: #ccc;
    }
    html,body{height:100%;margin:0}
    body{
      display:flex;align-items:center;justify-content:center;
      background:radial-gradient(circle,var(--bg) 0%, #031021 70%);
      color:var(--fg);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
      transition: color 0.3s ease;
      overflow: hidden;
    }
    
    .fullscreen-btn {
      position: absolute; top: 1rem; right: 1rem; z-index: 10;
      background: transparent; border: 1px solid var(--fg); color: var(--fg);
      padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; opacity: 0.5;
    }
    .fullscreen-btn:hover { opacity: 1; background: rgba(255,255,255,0.1); }

    .clock{
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      width: 100%;
      text-align:center;position:relative;
      padding-bottom: 5vh; 
    }
    
    .date{
      font-size: calc(min(5vw, 3vh) * var(--scale)); 
      opacity:0.8; margin-bottom: calc(1vh * var(--scale));
    }
    
    .time-container {
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: calc(min(22vw, 35vh) * var(--scale));
      font-weight:800; 
      line-height:1; 
      letter-spacing:0.02em; 
      font-variant-numeric: tabular-nums;
      text-shadow: 0 0 20px rgba(0,0,0,0.3);
    }
    
    .time-part {
      width: 1.25em;
      text-align: center;
      display: inline-block;
    }
    
    .time-colon {
      width: 0.3em;
      text-align: center;
      opacity: 0.8;
      position: relative; top: -0.05em;
    }

    .label-container {
      display: flex; 
      align-items: baseline;
      justify-content: center;
      gap: 0.5em;
      margin-top: calc(3vh * var(--scale));
      min-height: 3em;
    }

    .label-text {
      font-size: calc(min(4vw, 2.5vh) * var(--scale));
      font-weight:700; 
      opacity: 0.8;
    }

    .end-time-display {
      font-size: calc(min(10vw, 7vh) * var(--scale)); 
      font-weight: 800;
      line-height: 1;
      color: var(--accent);
      font-variant-numeric: tabular-nums;
    }
    
    body.overtime { color: var(--warn); }
    body.overtime .end-time-display { color: var(--warn); }
    body.overtime .fullscreen-btn { border-color: var(--warn); color: var(--warn); }

    /* „Ç≥„É≥„Éà„É≠„Éº„É©„Éº */
    .controls{
      display:flex; gap:0.5rem; justify-content:center; align-items: center;
      margin-top:1rem; flex-wrap: wrap;
      position: absolute; bottom: 1.5rem;
      width: 100%;
      opacity: 0; transition: opacity 0.3s;
      padding: 1rem;
      background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
    }
    body:hover .controls, .controls:focus-within { opacity: 1; }

    .controls input:not([type="checkbox"]):not([type="range"]), .controls button{font-size:16px; padding:0.4rem 0.6rem; border-radius:4px; border:none; outline: none;}
    
    .slider-container {
      display: flex; align-items: center; gap: 0.5rem;
      background: rgba(255,255,255,0.15); padding: 0.3rem 0.8rem; border-radius: 20px;
      color: rgba(255,255,255,0.9); font-size: 0.8rem;
      backdrop-filter: blur(4px);
    }
    input[type="range"] { cursor: pointer; width: 100px; }
    
    /* „Éà„Ç∞„É´„Çπ„Ç§„ÉÉ„ÉÅ„ÅÆCSS */
    .toggle-switch {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .switch {
      position: relative;
      display: inline-block;
      width: 48px;
      height: 24px;
    }
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--switch-off);
      transition: .4s;
      border-radius: 24px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: var(--switch-on);
    }
    input:checked + .slider:before {
      transform: translateX(24px);
    }
  </style>
</head>
<body>
  <button id="fsBtn" class="fullscreen-btn">ÂÖ®ÁîªÈù¢</button>

  <div class="clock">
    <div id="date" class="date"></div>
    
    <div class="time-container">
      <span id="time-h" class="time-part">--</span>
      <span class="time-colon">:</span>
      <span id="time-m" class="time-part">--</span>
      <span class="time-colon">:</span>
      <span id="time-s" class="time-part">--</span>
    </div>
    
    <div class="label-container">
      <span id="endTimeLabel" class="label-text"></span>
      <span id="endTimeDisplay" class="end-time-display"></span>
    </div>
  </div>

  <div class="controls">
    <div class="slider-container">
      <span>„Çµ„Ç§„Ç∫</span>
      <input id="sizeSlider" type="range" min="0.5" max="2.0" step="0.1" value="1.0">
    </div>

    <div class="toggle-switch slider-container">
      <span>ÈÄöÁü•Èü≥</span>
      <label class="switch">
        <input type="checkbox" id="soundToggle" checked>
        <span class="slider"></span>
      </label>
    </div>
    
    <button id="testSoundBtn">Èü≥„ÅÆ„ÉÜ„Çπ„Éà</button>

    <input id="endTimeInput" type="time">
    <input id="addMinutesInput" type="number" placeholder="+ÂàÜ" style="width:60px;">
    <button id="setEndTimeBtn">„Çª„ÉÉ„Éà</button>
    <button id="hideMemoBtn">„ÇØ„É™„Ç¢</button>
  </div>

  <script>
    (function(){
      let audioCtx;
      let audioPlayed = false;
      
      const timeH = document.getElementById('time-h');
      const timeM = document.getElementById('time-m');
      const timeS = document.getElementById('time-s');
      
      const dateEl = document.getElementById('date');
      const endTimeDisplay = document.getElementById('endTimeDisplay');
      const endTimeLabel = document.getElementById('endTimeLabel');
      const endTimeInput = document.getElementById('endTimeInput');
      const addMinutesInput = document.getElementById('addMinutesInput');
      const setEndTimeBtn = document.getElementById('setEndTimeBtn');
      const hideMemoBtn = document.getElementById('hideMemoBtn');
      const fsBtn = document.getElementById('fsBtn');
      const sizeSlider = document.getElementById('sizeSlider');
      const soundToggle = document.getElementById('soundToggle');
      const testSoundBtn = document.getElementById('testSoundBtn');
      const body = document.body;
      
      const STORAGE_KEY_SCALE = 'clockScale';
      const STORAGE_KEY_SOUND = 'clockSoundOn';

      // --- ÂàùÊúüÂåñÂá¶ÁêÜ ---

      const savedScale = localStorage.getItem(STORAGE_KEY_SCALE);
      if (savedScale) {
        document.documentElement.style.setProperty('--scale', savedScale);
        sizeSlider.value = savedScale;
      }
      sizeSlider.addEventListener('input', (e) => {
        document.documentElement.style.setProperty('--scale', e.target.value);
        localStorage.setItem(STORAGE_KEY_SCALE, e.target.value);
      });

      const savedSoundState = localStorage.getItem(STORAGE_KEY_SOUND);
      if (savedSoundState !== null) {
        soundToggle.checked = savedSoundState === 'true';
      }
      soundToggle.addEventListener('change', (e) => {
        localStorage.setItem(STORAGE_KEY_SOUND, e.target.checked);
      });
      
      // --- Èü≥Â£∞ÁîüÊàêÈñ¢Êï∞ ---
      
      function playNotificationSound(isTest = false) {
        if (!isTest && !soundToggle.checked) return;

        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }

        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();

        const frequency = 600; 
        const maxGain = 0.7;
        // üö® ‰øÆÊ≠£ÁÆáÊâÄ: ÊåÅÁ∂öÊôÇÈñì„Çí0.8Áßí„Å´Âª∂Èï∑ üö®
        const duration = 0.8; 
        const now = audioCtx.currentTime;
        
        gainNode.gain.setValueAtTime(0, now);
        gainNode.gain.linearRampToValueAtTime(maxGain, now + 0.05);
        // üö® ‰øÆÊ≠£ÁÆáÊâÄ: Èü≥„ÅåÂÆåÂÖ®„Å´Ê∂à„Åà„Çã„Çø„Ç§„Éü„É≥„Ç∞„Çíduration„Å´Âêà„Çè„Åõ„Çã üö®
        gainNode.gain.exponentialRampToValueAtTime(0.001, now + duration);

        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(frequency, now);

        oscillator.start();
        oscillator.stop(now + duration);
      }
      
      testSoundBtn.addEventListener('click', () => {
          playNotificationSound(true);
      });

      function pad(n){ return String(n).padStart(2,'0'); }

      function render(now){
        timeH.textContent = pad(now.getHours());
        timeM.textContent = pad(now.getMinutes());
        timeS.textContent = pad(now.getSeconds());
        
        const dateOpt = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'short' };
        dateEl.textContent = now.toLocaleDateString('ja-JP', dateOpt);

        if(endTimeInput.value){
          const [eh, em] = endTimeInput.value.split(':').map(Number);
          const currentTotalMins = now.getHours() * 60 + now.getMinutes();
          const endTotalMins = eh * 60 + em;

          if(currentTotalMins >= endTotalMins){
            endTimeDisplay.textContent = 'ÁµÇ‰∫Ü';
            endTimeLabel.textContent = '';
            body.classList.add('overtime');

            if(!audioPlayed){
                playNotificationSound(false);
                audioPlayed = true;
            }

          } else {
            body.classList.remove('overtime');
            audioPlayed = false;
          }
        } else {
          body.classList.remove('overtime');
          audioPlayed = false;
        }
      }

      function updateDisplay(){
        if(endTimeInput.value){
          if(!body.classList.contains('overtime')){
            endTimeLabel.textContent = 'Ë™≤È°åÁµÇ‰∫ÜÊôÇÂàª';
            endTimeDisplay.textContent = endTimeInput.value;
          }
        } else {
          endTimeLabel.textContent = '';
          endTimeDisplay.textContent = '';
          body.classList.remove('overtime');
          audioPlayed = false;
        }
      }

      setEndTimeBtn.addEventListener('click', ()=>{
        const addMinutes = parseInt(addMinutesInput.value);
        if(!isNaN(addMinutes)){
          const now = new Date();
          now.setMinutes(now.getMinutes() + addMinutes);
          endTimeInput.value = pad(now.getHours()) + ':' + pad(now.getMinutes());
        }
        body.classList.remove('overtime');
        audioPlayed = false;
        updateDisplay();
        render(new Date());
      });

      endTimeInput.addEventListener('input', updateDisplay);

      hideMemoBtn.addEventListener('click', ()=>{ 
        endTimeDisplay.textContent = '';
        endTimeLabel.textContent = '';
        endTimeInput.value = '';
        addMinutesInput.value = '';
        body.classList.remove('overtime');
        audioPlayed = false;
      });

      fsBtn.addEventListener('click', ()=>{
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen();
          fsBtn.textContent = 'Âæ©Â∏∞';
        } else {
          if (document.exitFullscreen) document.exitFullscreen();
          fsBtn.textContent = 'ÂÖ®ÁîªÈù¢';
        }
      });

      function startClock(){
        render(new Date());
        setTimeout(()=>{
          render(new Date());
          setInterval(()=>render(new Date()), 1000);
        }, 1000 - new Date().getMilliseconds());
      }

      startClock();
      document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState === 'visible') render(new Date()); });
    })();
  </script>
</body>
</html>